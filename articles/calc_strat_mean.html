<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculating stratified mean biomass/abundance • survdat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculating stratified mean biomass/abundance">
<meta property="og:description" content="survdat">
<meta property="og:image" content="https://noaa-edab.github.io/survdat/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">survdat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/survdat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/calc_strat_mean.html">Calculating stratified mean biomass/abundance</a>
    </li>
    <li>
      <a href="../articles/methodology.html">How biomass estimates are calculated</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/NOAA-EDAB/survdat/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calculating stratified mean
biomass/abundance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NOAA-EDAB/survdat/blob/HEAD/vignettes/calc_strat_mean.Rmd" class="external-link"><code>vignettes/calc_strat_mean.Rmd</code></a></small>
      <div class="hidden name"><code>calc_strat_mean.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>The <code>survdat</code> package is designed to work with the
Northeast Fisheries Science Center’s (NEFSC) bottom trawl surveys. The
NEFSC has been conducting standardized bottom trawl surveys in the fall
since 1963 and spring since 1968. The surveys follow a stratified random
design. Fish species and several invertebrate species are enumerated on
a tow by tow basis <span class="citation">[@Azarovitz_1981]</span>. The
data are housed in the NEFSC’s survey database (SVDBS) maintained by the
Ecosystem Survey Branch.</p>
<p>The <code>get_survdat_data</code> function will query the NEFSC
survey database (SVSDBS) and apply the appropriate calibration factors
associated with gear or vessel differences throughout the time series.
However, end users are usually interested in more derived estimates of
biomass or abundance that the tow by tow data retrieved via
<code>get_survdat_data</code>. The stratified random design of the
survey allows for the calculation of a stratified mean biomass or
abundance for a species or group of species.</p>
<p>To facilitate the calculation of these stratified means, the
<code>survdat</code> package has the function
<code>calc_stratified_mean</code>. This function is actually a wrapper
of several intermediate functions.</p>
<div class="figure">
<img src="calc_strat_mean_files/figure-html/functions-1.png" alt="Work flow of the `calc_stratified_mean` function with associated intermediate functions." width="576"><p class="caption">
Work flow of the <code>calc_stratified_mean</code> function with
associated intermediate functions.
</p>
</div>
</div>
<div class="section level2">
<h2 id="strat_prep">
<code>strat_prep</code><a class="anchor" aria-label="anchor" href="#strat_prep"></a>
</h2>
<p>The first function called is <code>strat_prep</code>. As the name
implies, <code>strat_prep</code> prepares the data set so that the
stratified means can be calculated. Nested within this function are the
<code>post_strat</code> and <code>get_area</code> functions. The
<code>post_strat</code> function is used if not following the stratified
design of the survey. It is automatically called if the user inputs an
<code>sf</code> object rather than the specified default <em>‘NEFSC
strata’</em>. When this occurs, the R object <code>poststratData</code>
generated by <code>post_strat</code> will replace the
<code>survdat</code> data object and is ultimately passed through to the
<code>prepData</code> object. This will also turn on the
<code>poststratFlag</code> which is used by the <code>strat_mean</code>
function.</p>
<p>At this point you can also filter the data using the
<code>filterBySeason</code> or <code>filterByArea</code> arguments. The
first will allow you to select one of three options: <em>‘FALL’</em>,
<em>‘SPRING’</em>, or <em>‘all’</em>. The default option is
<em>‘all’</em>. Note that selecting both the spring and fall survey will
combine the two surveys. So if you want to have separate means for both
surveys you need to run them independently. The second filter will allow
you to select a subset of strata to use in your analysis.</p>
<p>The rest of the prep work done by <code>strat_prep</code> is counting
the number of tows per strata and the proportional weight of the strata.
This adds the columns <code>ntows</code> and <code>W.h</code> to the
data set. The number of tows (<code>ntows</code>) is simply the length
of unique station records per stratum:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Count the number of stations in each year for each Region</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">stations</span>, <span class="va">YEAR</span>, <span class="va">STRAT</span><span class="op">)</span></span>
<span>  <span class="va">stations</span><span class="op">[</span>, <span class="va">ntows</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">STATION</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stations</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Proportional weights of the strata are based on their area. The area
of the strata are calculated using the <code>get_area</code> function
which uses a Lambert Conformal Conic projection. The
<code>get_area</code> function creates a list of strata and their
corresponding areas (A) which <code>strat_prep</code> uses to calculate
the relative weight (W) of each strata h as:</p>
<p><span class="math display">\[\begin{equation}
    \label{PropArea}
    \begin{split}
    W_h = \frac{A_h}{\sum{A_h}}
\end{split}
\end{equation}\]</span></p>
<p>After counting the number of tows and calculating the relative weight
of each strata, the resulting <code>prepData</code> is then passed to
the <code>strat_mean</code> function.</p>
</div>
<div class="section level2">
<h2 id="strat_mean">
<code>strat_mean</code><a class="anchor" aria-label="anchor" href="#strat_mean"></a>
</h2>
<p>Once the data has been prepared using <code>strat_prep</code> the
real calculations are carried out in the function
<code>strat_mean</code>. This function will remove duplicate catch
records that may be present due to length data, merge sexed species (or
leave separate if specified), calculate the total number of stations for
the year, subset the species list if desired, and calculate the
stratified mean biomass and adundance along with the associated
variance.</p>
<p>The first few actions are straightforward. Length data is removed to
ensure each catch is accounted for once.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Remove length data if present</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">stratmeanData</span>, <span class="va">CRUISE6</span>, <span class="va">STRATUM</span>, <span class="va">STATION</span>, <span class="va">SVSPP</span>, <span class="va">CATCHSEX</span><span class="op">)</span></span>
<span>  <span class="va">stratmeanData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">stratmeanData</span>, by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stratmeanData</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">stratmeanData</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'LENGTH'</span>, <span class="st">'NUMLEN'</span><span class="op">)</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></code></pre></div>
<p>Similarly, catch from sexed species such as spiny dogfish are merged
or kept separate. The default is to merge them but a user may specify to
keep them separate by setting the <code>mergesexFlag</code> to
<em>FALSE</em>. Sexed species are kept separate by changing their group
designation to a concatenation of their group name and catch sex.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Merge sex or keep separate</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">mergesexFlag</span> <span class="op">==</span> <span class="cn">F</span><span class="op">)</span> <span class="va">stratmeanData</span><span class="op">[</span>, <span class="va">group</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">CATCHSEX</span>, sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">stratmeanData</span>, <span class="va">CRUISE6</span>, <span class="va">strat</span>, <span class="va">STATION</span>, <span class="va">group</span><span class="op">)</span></span>
<span>  <span class="va">stratmeanData</span><span class="op">[</span>, <span class="va">BIOMASS</span>   <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">BIOMASS</span><span class="op">)</span>,   by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stratmeanData</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">stratmeanData</span><span class="op">[</span>, <span class="va">ABUNDANCE</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ABUNDANCE</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stratmeanData</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">stratmeanData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">stratmeanData</span>, by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stratmeanData</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The total number of tows per year is the sum of <code>ntows</code>
for all of the strata sampled for a given year.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Calculate total number of stations per year</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">stratmeanData</span>, <span class="va">strat</span>, <span class="va">YEAR</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">stratmeanData</span>, by <span class="op">=</span> <span class="fu">key</span><span class="op">(</span><span class="va">stratmeanData</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">N</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ntows</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'YEAR'</span><span class="op">]</span></span>
<span>  <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">N</span>, <span class="st">'V1'</span>, <span class="st">'N'</span><span class="op">)</span></span></code></pre></div>
<p>Species or group list can be subsetted using the
<code>filterByGroup</code> argument.</p>
</div>
<div class="section level2">
<h2 id="stratified-mean-and-variance-calculations">Stratified mean and variance calculations<a class="anchor" aria-label="anchor" href="#stratified-mean-and-variance-calculations"></a>
</h2>
<p>Finally, the stratified mean biomass is calculated as:</p>
<p><span class="math display">\[\begin{equation}
    \label{Stratifed}
    \bar{B} = \sum_{h = 1}^{L}{W_h\bar{B_h}}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\bar{B}\)</span> is the stratified
mean biomass, <span class="math inline">\(W_h\)</span> and <span class="math inline">\(\bar{B_h}\)</span> the relative weight and mean
biomass from stratum <span class="math inline">\(h\)</span>, and <span class="math inline">\(L\)</span> the total number of strata. <span class="math inline">\(\bar{B_h}\)</span> is calculated as:</p>
<p><span class="math display">\[\begin{equation}
    \label{mean biomass}
    \bar{B_h} = \frac{\sum_{i = 1}^n{B_i}}{n_h}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(B_i\)</span> is the biomass at
station <span class="math inline">\(i\)</span> and <span class="math inline">\(n_h\)</span> the number of stations in stratum
<span class="math inline">\(h\)</span>.</p>
<p>Additionally, variance is calculated as:</p>
<p><span class="math display">\[\begin{equation}
    \label{stratified variance}
    s_{\bar{B}}^2 = \sum_{h = 1}^L{\frac{W_{h}^{2} s_{h}^{2}}{n_{h}}}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(s_{\bar{B}}^2\)</span> is the
variance of the stratified mean biomass and <span class="math inline">\(s_h^2\)</span> the variance of the mean for
stratum <span class="math inline">\(h\)</span>. <span class="math inline">\(s_h^2\)</span> is calculated as:</p>
<p><span class="math display">\[\begin{equation}
    \label{strata variance}
    s_h^2 = \frac{{(B_i - \bar{B_h})}^2}{n_h - 1}
\end{equation}\]</span></p>
<p>If the <code>poststratFlag</code> was set to <em>TRUE</em> because a
different stratification was used rather than the survey design, the
variance calculation becomes:</p>
<p><span class="math display">\[\begin{equation}
    \label{penalty variance}
    s_{\bar{B}}^2 = \frac{\sum_{h = 1}^L{s_{h}^{2} W_h}}{N} +
                    \sum_{h = 1}^L{\frac{(1 - W_h)s_h^2}{N^2}}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(N\)</span> is the total number of
stations for the year.</p>
<p>The final calculation for the <code>calc_stratified_mean</code>
function is the standard error of the mean which is:</p>
<p><span class="math display">\[\begin{equation}
    \label{standard error}
    s_{\bar{B}} = \sqrt{s_{\bar{B}}^2}
\end{equation}\]</span></p>
<p>Similar calculations are carried out for abundance with numbers
replacing biomass in the equations above.</p>
</div>
<div class="section level2">
<h2 id="tidy-data">Tidy data<a class="anchor" aria-label="anchor" href="#tidy-data"></a>
</h2>
<p>The default output from the <code>calc_stratified_mean</code>
function is a wide table with a row for every year/group combination.
You can elect a tidy format (long) instead by specifying the argument
<code>tidy</code> = <em>TRUE</em>. This will melt the table down so that
each year/group combo will now have a seperate row for stratified mean
biomass, stratified mean abundance, variance of the stratified mean
biomass, and variance of the stratified mean abundance. The tidy data
will also append a units column to the data set. The units for the
stratified mean biomass is <span class="math inline">\(kg
tow^-1\)</span> while the stratified mean abundance is <span class="math inline">\(numbers tow^-1\)</span>. Note that the tidy data
set does not include the standard errors.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Sean Lucey, Andy Beet.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
